<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rudy-auth 테스트</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .status {
            padding: 12px;
            border-radius: 4px;
            margin-top: 16px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #cce5ff; color: #004085; }
        pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .hidden { display: none; }
        .token-display { margin-top: 16px; }
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .step-num {
            width: 24px;
            height: 24px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .step.done .step-num { background: #28a745; }
        .step.current .step-num { background: #ffc107; color: #333; }
        .tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 2px solid #dee2e6;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover { color: #007bff; }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: 500;
        }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .divider {
            text-align: center;
            margin: 16px 0;
            color: #6c757d;
            position: relative;
        }
        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #dee2e6;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
    </style>
</head>
<body>
    <h1>rudy-auth 테스트</h1>

    <!-- 로그인된 상태 -->
    <div class="card hidden" id="loggedInCard">
        <h2>로그인됨</h2>
        <div class="status success" id="loggedInUserInfo"></div>
        <button class="btn-secondary" id="proceedOAuthBtn" style="margin-top: 16px;">OAuth2 진행</button>
        <button class="btn-danger" id="simpleLogoutBtn" style="margin-top: 8px;">로그아웃</button>
    </div>

    <!-- 회원가입/로그인 탭 -->
    <div class="card" id="authCard">
        <div class="tabs">
            <button class="tab active" data-tab="login">로그인</button>
            <button class="tab" data-tab="register">회원가입</button>
        </div>

        <!-- 로그인 탭 -->
        <div class="tab-content active" id="loginTab">
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" value="test" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" value="test123" required>
                </div>
                <button type="submit">로그인</button>
            </form>
            <div id="loginStatus" class="status hidden"></div>
        </div>

        <!-- 회원가입 탭 -->
        <div class="tab-content" id="registerTab">
            <form id="registerForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" required placeholder="사용자명">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" required placeholder="비밀번호">
                </div>
                <div class="form-group">
                    <label>Password 확인</label>
                    <input type="password" id="regPasswordConfirm" required placeholder="비밀번호 확인">
                </div>
                <div class="form-group">
                    <label>Nickname (선택)</label>
                    <input type="text" id="regNickname" placeholder="닉네임 (미입력시 자동 생성)">
                </div>
                <button type="submit" class="btn-success">회원가입</button>
            </form>
            <div id="registerStatus" class="status hidden"></div>
        </div>
    </div>

    <!-- 진행 상태 -->
    <div class="card hidden" id="progressCard">
        <h2>OAuth2 진행 상태</h2>
        <div class="step" id="step1">
            <span class="step-num">1</span>
            <span>로그인 (세션 생성)</span>
        </div>
        <div class="step" id="step2">
            <span class="step-num">2</span>
            <span>Authorization Code 요청</span>
        </div>
        <div class="step" id="step3">
            <span class="step-num">3</span>
            <span>Token 교환</span>
        </div>
        <div class="step" id="step4">
            <span class="step-num">4</span>
            <span>완료</span>
        </div>
    </div>

    <!-- Step 2: Authorization Code -->
    <div class="card hidden" id="authorizeCard">
        <h2>Step 2: Authorization Code 요청</h2>
        <p>PKCE code_verifier가 생성되었습니다.</p>
        <button id="authorizeBtn">Authorization Code 요청</button>
        <div id="authorizeStatus" class="status hidden"></div>
    </div>

    <!-- Step 3: Token 교환 (callback 처리) -->
    <div class="card hidden" id="tokenCard">
        <h2>Step 3: Token 교환</h2>
        <p>Authorization Code를 받았습니다. Token으로 교환합니다.</p>
        <pre id="codeDisplay"></pre>
        <button id="tokenBtn">Token 교환</button>
        <div id="tokenStatus" class="status hidden"></div>
    </div>

    <!-- 결과 -->
    <div class="card hidden" id="resultCard">
        <h2>결과: Access Token</h2>
        <div class="token-display">
            <pre id="tokenDisplay"></pre>
        </div>
        <button class="btn-secondary" id="userInfoBtn">UserInfo 조회</button>
        <button class="btn-danger" id="logoutBtn">로그아웃</button>
        <div id="userInfoDisplay" class="status hidden" style="margin-top: 16px;"></div>
    </div>

    <script>
        const AUTH_SERVER = 'http://localhost:8083';
        const CLIENT_ID = 'rudy-react';
        const CLIENT_SECRET = 'react-secret';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let codeVerifier = '';
        let authorizationCode = '';
        let accessToken = '';
        let refreshToken = '';

        // 탭 전환
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
            });
        });

        // PKCE 유틸리티
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64UrlEncode(new Uint8Array(hash));
        }

        function base64UrlEncode(buffer) {
            return btoa(String.fromCharCode(...buffer))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // UI 업데이트
        function updateStep(stepNum) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById('step' + i);
                el.classList.remove('done', 'current');
                if (i < stepNum) el.classList.add('done');
                if (i === stepNum) el.classList.add('current');
            }
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = 'status ' + type;
            el.innerHTML = message;
            el.classList.remove('hidden');
        }

        // 회원가입
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const nickname = document.getElementById('regNickname').value;

            if (password !== passwordConfirm) {
                showStatus('registerStatus', '비밀번호가 일치하지 않습니다.', 'error');
                return;
            }

            try {
                const response = await fetch(`${AUTH_SERVER}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nickname: nickname || null })
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus('registerStatus',
                        `회원가입 성공!<br>ID: ${data.id}<br>Username: ${data.username}<br>Nickname: ${data.nickname}`,
                        'success'
                    );
                    // 로그인 탭으로 전환하고 username 채우기
                    setTimeout(() => {
                        document.querySelector('[data-tab="login"]').click();
                        document.getElementById('username').value = username;
                        document.getElementById('password').value = password;
                    }, 1500);
                } else {
                    const error = await response.text();
                    showStatus('registerStatus', `회원가입 실패: ${error}`, 'error');
                }
            } catch (err) {
                showStatus('registerStatus', `오류: ${err.message}`, 'error');
            }
        });

        // 로그인
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${AUTH_SERVER}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus('loginStatus', `로그인 성공! Session: ${data.sessionId}`, 'success');

                    // 진행 상태 표시
                    document.getElementById('progressCard').classList.remove('hidden');
                    updateStep(2);

                    // PKCE 생성
                    codeVerifier = generateCodeVerifier();
                    sessionStorage.setItem('pkce_verifier', codeVerifier);

                    document.getElementById('authorizeCard').classList.remove('hidden');
                } else {
                    const error = await response.text();
                    showStatus('loginStatus', `로그인 실패: ${error}`, 'error');
                }
            } catch (err) {
                showStatus('loginStatus', `오류: ${err.message}`, 'error');
            }
        });

        // Authorization Code 요청
        document.getElementById('authorizeBtn').addEventListener('click', async () => {
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            const params = new URLSearchParams({
                response_type: 'code',
                client_id: CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                scope: 'openid profile read write',
                code_challenge: codeChallenge,
                code_challenge_method: 'S256',
                state: 'test_state_' + Date.now()
            });

            window.location.href = `${AUTH_SERVER}/oauth2/authorize?${params}`;
        });

        // Token 교환
        document.getElementById('tokenBtn').addEventListener('click', async () => {
            const storedVerifier = sessionStorage.getItem('pkce_verifier');

            try {
                const params = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: authorizationCode,
                    redirect_uri: REDIRECT_URI,
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    code_verifier: storedVerifier
                });

                const response = await fetch(`${AUTH_SERVER}/oauth2/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    refreshToken = data.refresh_token;

                    showStatus('tokenStatus', 'Token 발급 성공!', 'success');
                    updateStep(4);

                    document.getElementById('tokenDisplay').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('resultCard').classList.remove('hidden');

                    sessionStorage.removeItem('pkce_verifier');
                } else {
                    const error = await response.text();
                    showStatus('tokenStatus', `Token 발급 실패: ${error}`, 'error');
                }
            } catch (err) {
                showStatus('tokenStatus', `오류: ${err.message}`, 'error');
            }
        });

        // UserInfo 조회
        document.getElementById('userInfoBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${AUTH_SERVER}/userinfo`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userInfoDisplay').className = 'status success';
                    document.getElementById('userInfoDisplay').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    document.getElementById('userInfoDisplay').classList.remove('hidden');
                } else {
                    document.getElementById('userInfoDisplay').className = 'status error';
                    document.getElementById('userInfoDisplay').textContent = 'UserInfo 조회 실패: ' + response.status;
                    document.getElementById('userInfoDisplay').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('userInfoDisplay').className = 'status error';
                document.getElementById('userInfoDisplay').textContent = '오류: ' + err.message;
                document.getElementById('userInfoDisplay').classList.remove('hidden');
            }
        });

        // 로그아웃
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${AUTH_SERVER}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (e) {}

            sessionStorage.clear();
            accessToken = '';
            refreshToken = '';
            window.location.href = window.location.pathname;
        });

        // 로그인 상태 확인
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${AUTH_SERVER}/api/auth/me`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (e) {}
            return null;
        }

        // 로그인된 화면 표시
        function showLoggedInState(user) {
            document.getElementById('authCard').classList.add('hidden');
            document.getElementById('loggedInCard').classList.remove('hidden');
            document.getElementById('loggedInUserInfo').innerHTML = `<strong>${user.username}</strong>님으로 로그인되어 있습니다.`;
        }

        // 간단 로그아웃
        document.getElementById('simpleLogoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${AUTH_SERVER}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (e) {}
            sessionStorage.clear();
            window.location.reload();
        });

        // OAuth2 진행 버튼
        document.getElementById('proceedOAuthBtn').addEventListener('click', async () => {
            document.getElementById('loggedInCard').classList.add('hidden');
            document.getElementById('progressCard').classList.remove('hidden');
            updateStep(2);

            codeVerifier = generateCodeVerifier();
            sessionStorage.setItem('pkce_verifier', codeVerifier);

            document.getElementById('authorizeCard').classList.remove('hidden');
        });

        // 페이지 로드 시 callback 처리
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showStatus('loginStatus', `인증 오류: ${error} - ${params.get('error_description')}`, 'error');
                return;
            }

            if (code) {
                authorizationCode = code;

                // 탭 카드 숨기기
                document.getElementById('authCard').classList.add('hidden');

                // 진행 상태 표시
                document.getElementById('progressCard').classList.remove('hidden');
                updateStep(3);

                document.getElementById('tokenCard').classList.remove('hidden');
                document.getElementById('codeDisplay').textContent = `code: ${code}\nstate: ${params.get('state')}`;

                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            // OAuth callback이 아니면 로그인 상태 확인
            const user = await checkLoginStatus();
            if (user) {
                showLoggedInState(user);
            }
        });
    </script>
</body>
</html>
